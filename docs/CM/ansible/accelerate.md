# 优化Ansible速度

[[toc]]

## 1. Ansible与SaltStack的对比

| 特点         | Ansible                                | SaltStack                          |
| ------------ | -------------------------------------- | ---------------------------------- |
| 语言         | 使用YAML语法编写Playbooks              | 使用Python语法编写States           |
| 是否有客户端 | 无                                     | 有                                 |
| 运行方式     | Push模式，通过SSH远程执行操作          | Push或Pull模式，通过ZeroMQ进行通信 |
| 应用范围     | 适用于配置管理、自动化部署、应用发布等 | 适用于配置管理、监控、自动部署     |
| 扩展性       | 插件丰富，易于扩展功能                 | 拥有强大的扩展性，能够定制各种功能 |
| 管理和监控   | 简单易用，可直接在控制端执行操作       | 开箱即用，自带管理和监控功能       |
| 社区支持     | 拥有庞大的社区用户群                   | 社区规模较小，但质量较高           |
| 学习曲线     | 相对较低，易上手                       | 学习曲线较陡峭，需要一定的技术基础 |
| 安全可控     | 通过SSH加密传输数据，较为安全          | 通过ZeroMQ传输数据，也较为安全     |

有些人说Ansible的执行效率比SaltStack低，确实，使用默认的SSH方式通信，效率远低于SaltStack的zeromq消息队列。下面来介绍一些优化Ansible执行速度的方法。



### 1.1 VirtualBox虚拟机说明

使用以下环境进行测试。

| 序号 | 虚拟机         | 主机名  | IP             | CPU  | 内存 | 说明             |
| ---- | -------------- | ------- | -------------- | ---- | ---- | ---------------- |
| 1    | ansible-master | ansible | 192.168.56.120 | 2核  | 4G   | Ansible控制节点  |
| 2    | ansible-node1  | node1   | 192.168.56.121 | 2核  | 2G   | Ansible工作节点1 |
| 3    | ansible-node2  | node2   | 192.168.56.122 | 2核  | 2G   | Ansible工作节点2 |
| 4    | ansible-node3  | node3   | 192.168.56.123 | 2核  | 2G   | Ansible工作节点3 |



### 1.2 测试剧本说明

你可以参考[ansible role角色(4)--include的使用](./role_4_include.md) 我们使用该剧本来测试执行时间。

由于我之前多次执行过剧本，相关配置差不多都配置到呼工作节点了。此时执行一遍剧本文件，看看用时多久：

```sh
# 第一次统计输出时间
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml

PLAY [basehosts] *****************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Show hostname] ******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "ansible-node1"
}
ok: [192.168.56.123] => {
    "msg": "ansible-node3"
}
ok: [192.168.56.122] => {
    "msg": "ansible-node2"
}

TASK [base : Set hostname] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.123]
ok: [192.168.56.121]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.122]
ok: [192.168.56.121]

TASK [base : Set SELinux prints warnings instead of enforcing] *******************************************************************************************************************************************************************************************************************************
skipping: [192.168.56.121]
skipping: [192.168.56.122]
skipping: [192.168.56.123]

TASK [base : Ensure SELinux is set to disable mode] ******************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Create a directory if it does not exist] ****************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [base : Backup old repo config] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Copy repo and pypi config] ******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.123] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.122] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})

TASK [base : ensure a list of packages installed] ********************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [create base folder] ********************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.122]
changed: [192.168.56.123]

TASK [base : Extract safe-rm-0.12.tar.gz into /srv/safe-rm] **********************************************************************************************************************************************************************************************************************************
changed: [192.168.56.122]
changed: [192.168.56.121]
changed: [192.168.56.123]

TASK [base : Move safe-rm to /usr/bin] *******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Delete temp folder] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.122]
changed: [192.168.56.121]
changed: [192.168.56.123]

TASK [base : Copy safe-rm config] ************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [base : Update pip command] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.123]
changed: [192.168.56.122]
changed: [192.168.56.121]

TASK [base : Install python package] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.123]
ok: [192.168.56.121]

TASK [base : Sync time at every 10 minutes] **************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.123]
ok: [192.168.56.121]

TASK [base : Sync time at 2:30 am] ***********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [base : Print the IP] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "HOST_IP: 192.168.56.121"
}
ok: [192.168.56.122] => {
    "msg": "HOST_IP: 192.168.56.122"
}
ok: [192.168.56.123] => {
    "msg": "HOST_IP: 192.168.56.123"
}

TASK [base : Remove sshkey file] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa.pub)

TASK [base : Generate SSH key pair] **********************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.122]
changed: [192.168.56.123]

TASK [base : Copy alias config] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.121]
ok: [192.168.56.122]

TASK [base : Insert block to .bashrc] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

PLAY RECAP ***********************************************************************************************************************************************************************************************************************************************************************************
192.168.56.121             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.122             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.123             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0


real    0m25.265s
user    0m9.161s
sys     0m4.371s
[root@ansible ansible_playbooks]#
```

时间输出结果说明：

- real是程序的实际运行时间，从程序开始到程序执行结束时所消耗的时间，包括CPU的用时和所有延迟程序执行的因素的总和。CPU用时被划分为user和sys两块。
- user是用户态的时间，表示程序本身，以及它所调用的库中的子例程使用的时间。
- sys是内核态的时间，是由程序直接或间接调用的系统调用执行的时间。
- 单核情况，real远远大于user和sys之和。

- real=CPU用时+其他因素时间。
- CPU用时=user+sys。

因此，我们在此处主要关注`real`用时输出。



重复再执行三次，看输出结果：

```sh
# 第2次执行，统计输出时间
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml
...过程输出省略
real    0m16.135s
user    0m9.308s
sys     0m4.259s
[root@ansible ansible_playbooks]#
# 第3次执行，统计输出时间
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml
...过程输出省略
real    0m15.673s
user    0m9.404s
sys     0m3.874s
[root@ansible ansible_playbooks]#
# 第4次执行，统计输出时间
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml
...过程输出省略
real    0m15.562s
user    0m9.466s
sys     0m3.725s
[root@ansible ansible_playbooks]#
```

可以看到，后面3次实际用时差不多都是16秒钟。我们后面测试就来对比这个时间。

## 2. 优化策略

### 2.1 开启SSH长连接

在OpenSSH 5.6版本以后SSH就支持了Multiplexing。如果Ansible控制节点SSH版本高于5.6就可以开启SSH长连接。

我们来检查一下：

```sh
[root@ansible ~]# ssh -V
OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017
[root@ansible ~]#
```

可以看到，控制节点SSH版本为OpenSSH_7.4p1，满足要求。

直接在`ansible.cfg`文件中设置SSH长连接即可。设置参数如下：

```
ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d
```

`ControlPersist=5d`这个参数是设置整个长连接保持时间为5天。如果开启该功能，通过SSH连接过的的设备都会在当前`~/.ansible/cp`目录下生成一个socket文件。

先来看看配置文件中有没有这个参数：

```sh
[root@ansible ~]# grep sh_args /etc/ansible/ansible.cfg
#ssh_args = -C -o ControlMaster=auto -o ControlPersist=60s
[root@ansible ~]#
```

可以看到，默认注释掉了该参数。

修改前，先备份一下原来的配置文件：

```sh
[root@ansible ~]# ll /etc/ansible/ansible.cfg*
-rw-r--r--. 1 root root 19985 Jan 16  2022 /etc/ansible/ansible.cfg
[root@ansible ~]# cp -p /etc/ansible/ansible.cfg /etc/ansible/ansible.cfg.default
```

然后使用vim编辑/etc/ansible/ansible.cfg配置文件，并增加`ssh_args`参数，修改后查看配置信息：

```sh
[root@ansible ~]# grep -C5 sh_args /etc/ansible/ansible.cfg
[ssh_connection]

# ssh arguments to use
# Leaving off ControlPersist will result in poor performance, so use
# paramiko on older platforms rather than removing it, -C controls compression use
#ssh_args = -C -o ControlMaster=auto -o ControlPersist=60s
ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d

# The base directory for the ControlPath sockets.
# This is the "%(directory)s" in the control_path option
#
# Example:
[root@ansible ~]#
```

为了检查后面会不会连接长连接，先安装`net-tools`包，然后使用`netstat`命令查看当前连接信息：

```sh
[root@ansible ~]# yum install net-tools
Loaded plugins: fastestmirror
Determining fastest mirrors
base                                                                                                                                                                                                                                                                   | 3.6 kB  00:00:00
epel                                                                                                                                                                                                                                                                   | 4.7 kB  00:00:00
extras                                                                                                                                                                                                                                                                 | 2.9 kB  00:00:00
updates                                                                                                                                                                                                                                                                | 2.9 kB  00:00:00
(1/5): epel/x86_64/group_gz                                                                                                                                                                                                                                            | 100 kB  00:00:00
(2/5): epel/x86_64/updateinfo                                                                                                                                                                                                                                          | 1.0 MB  00:00:00
(3/5): extras/7/x86_64/primary_db                                                                                                                                                                                                                                      | 250 kB  00:00:00
(4/5): epel/x86_64/primary_db                                                                                                                                                                                                                                          | 7.0 MB  00:00:01
(5/5): updates/7/x86_64/primary_db                                                                                                                                                                                                                                     |  25 MB  00:00:08
Resolving Dependencies
--> Running transaction check
---> Package net-tools.x86_64 0:2.0-0.25.20131004git.el7 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

==============================================================================================================================================================================================================================================================================================
 Package                                                             Arch                                                             Version                                                                            Repository                                                      Size
==============================================================================================================================================================================================================================================================================================
Installing:
 net-tools                                                           x86_64                                                           2.0-0.25.20131004git.el7                                                           base                                                           306 k

Transaction Summary
==============================================================================================================================================================================================================================================================================================
Install  1 Package

Total download size: 306 k
Installed size: 917 k
Is this ok [y/d/N]: y
Downloading packages:
net-tools-2.0-0.25.20131004git.el7.x86_64.rpm                                                                                                                                                                                                                          | 306 kB  00:00:00
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : net-tools-2.0-0.25.20131004git.el7.x86_64                                                                                                                                                                                                                                  1/1
  Verifying  : net-tools-2.0-0.25.20131004git.el7.x86_64                                                                                                                                                                                                                                  1/1

Installed:
  net-tools.x86_64 0:2.0-0.25.20131004git.el7

Complete!
[root@ansible ~]# netstat -ato
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 localhost:smtp          0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 ansible:37438           101.6.15.130:https      TIME_WAIT   timewait (41.86/0/0)
tcp        0      0 ansible:37436           101.6.15.130:https      TIME_WAIT   timewait (57.06/0/0)
tcp        0      0 ansible:37444           101.6.15.130:https      TIME_WAIT   timewait (49.59/0/0)
tcp        0      0 ansible:37446           101.6.15.130:https      TIME_WAIT   timewait (57.04/0/0)
tcp        0     48 ansible-master:ssh      192.168.56.1:8421       ESTABLISHED on (0.22/0/0)
tcp        0      0 ansible:37442           101.6.15.130:https      TIME_WAIT   timewait (43.11/0/0)
tcp        0      0 ansible:37439           101.6.15.130:https      TIME_WAIT   timewait (49.55/0/0)
tcp        0      0 ansible-master:ssh      192.168.56.1:8423       ESTABLISHED keepalive (4321.38/0/0)
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN      off (0.00/0/0)
tcp6       0      0 localhost:smtp          [::]:*                  LISTEN      off (0.00/0/0)
[root@ansible ~]#
```

切换到剧本目录，再次执行剧本：

```sh
[root@ansible ~]# cd ansible_playbooks/
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml

PLAY [basehosts] *****************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Show hostname] ******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "ansible-node1"
}
ok: [192.168.56.122] => {
    "msg": "ansible-node2"
}
ok: [192.168.56.123] => {
    "msg": "ansible-node3"
}

TASK [base : Set hostname] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.122]
ok: [192.168.56.121]

TASK [base : Set SELinux prints warnings instead of enforcing] *******************************************************************************************************************************************************************************************************************************
skipping: [192.168.56.121]
skipping: [192.168.56.122]
skipping: [192.168.56.123]

TASK [base : Ensure SELinux is set to disable mode] ******************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.121]
ok: [192.168.56.122]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Create a directory if it does not exist] ****************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.122]
ok: [192.168.56.121]

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Backup old repo config] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Copy repo and pypi config] ******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.123] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.121] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})

TASK [base : ensure a list of packages installed] ********************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [create base folder] ********************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.122]
changed: [192.168.56.121]
changed: [192.168.56.123]

TASK [base : Extract safe-rm-0.12.tar.gz into /srv/safe-rm] **********************************************************************************************************************************************************************************************************************************
changed: [192.168.56.123]
changed: [192.168.56.122]
changed: [192.168.56.121]

TASK [base : Move safe-rm to /usr/bin] *******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Delete temp folder] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.123]
changed: [192.168.56.122]

TASK [base : Copy safe-rm config] ************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Update pip command] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.123]
changed: [192.168.56.122]
changed: [192.168.56.121]

TASK [base : Install python package] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.123]
ok: [192.168.56.121]

TASK [base : Sync time at every 10 minutes] **************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Sync time at 2:30 am] ***********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Print the IP] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "HOST_IP: 192.168.56.121"
}
ok: [192.168.56.122] => {
    "msg": "HOST_IP: 192.168.56.122"
}
ok: [192.168.56.123] => {
    "msg": "HOST_IP: 192.168.56.123"
}

TASK [base : Remove sshkey file] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa.pub)

TASK [base : Generate SSH key pair] **********************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.123]
changed: [192.168.56.122]

TASK [base : Copy alias config] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Insert block to .bashrc] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

PLAY RECAP ***********************************************************************************************************************************************************************************************************************************************************************************
192.168.56.121             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.122             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.123             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0


real    0m16.704s
user    0m9.431s
sys     0m4.175s
[root@ansible ansible_playbooks]#
```

可以看到，开启长连接后，第一次执行剧本，用时16s，与未开启长连接前用时一致。



检查是否用长连接：

```sh
[root@ansible ansible_playbooks]# netstat -ato
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 localhost:smtp          0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 ansible-master:48610    ansible-node3:ssh       ESTABLISHED keepalive (7040.48/0/0)
tcp        0      0 ansible-master:36912    ansible-node2:ssh       ESTABLISHED keepalive (7040.48/0/0)
tcp        0      0 ansible-master:44752    ansible-node1:ssh       ESTABLISHED keepalive (7040.48/0/0)
tcp        0     48 ansible-master:ssh      192.168.56.1:8421       ESTABLISHED on (0.23/0/0)
tcp        0      0 ansible-master:ssh      192.168.56.1:8423       ESTABLISHED keepalive (4025.82/0/0)
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN      off (0.00/0/0)
tcp6       0      0 localhost:smtp          [::]:*                  LISTEN      off (0.00/0/0)
[root@ansible ansible_playbooks]# ll ~/.ansible/cp/
total 0
srw-------. 1 root root 0 Mar 17 12:18 6e835d9f0e
srw-------. 1 root root 0 Mar 17 12:18 a734bde817
srw-------. 1 root root 0 Mar 17 12:18 f59c3dce9d
[root@ansible ansible_playbooks]#
```

![Snipaste_2024-03-17_12-22-48.png](/img/Snipaste_2024-03-17_12-22-48.png)

可以看到，长连接建立了，对立socket文件也生成了。

也可以通过以下命令判断`~/.ansible/cp`目录下的文件是`socket`文件：

```sh
[root@ansible ansible_playbooks]# file ~/.ansible/cp/6e835d9f0e
/root/.ansible/cp/6e835d9f0e: socket
[root@ansible ansible_playbooks]# file ~/.ansible/cp/a734bde817
/root/.ansible/cp/a734bde817: socket
[root@ansible ansible_playbooks]# file ~/.ansible/cp/f59c3dce9d
/root/.ansible/cp/f59c3dce9d: socket
[root@ansible ansible_playbooks]#
```



在工作节点上面检查一下：

```sh
# 在节点1上检查连接
[root@ansible-node1 ~]# netstat -ato|head -n 2 && netstat -ato|grep ansible
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0      0 ansible-node1:ssh       192.168.56.1:9859       ESTABLISHED keepalive (7084.41/0/0)
tcp        0      0 ansible-node1:ssh       192.168.56.120:44752    ESTABLISHED keepalive (6789.50/0/0)
tcp        0      0 ansible-node1:ssh       192.168.56.1:9861       ESTABLISHED keepalive (7084.41/0/0)
[root@ansible-node1 ~]#

# 在节点2上检查连接
[root@ansible-node2 ~]# netstat -ato|head -n 2 && netstat -ato|grep ansible
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0      0 ansible-node2:ssh       192.168.56.1:9899       ESTABLISHED keepalive (7215.16/0/0)
tcp        0      0 ansible-node2:ssh       192.168.56.120:36912    ESTABLISHED keepalive (6723.64/0/0)
tcp        0      0 ansible-node2:ssh       192.168.56.1:9897       ESTABLISHED keepalive (7215.16/0/0)
[root@ansible-node2 ~]#

# 在节点3上检查连接
[root@ansible-node3 ~]# netstat -ato|head -n 2 && netstat -ato|grep ansible
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0    160 ansible-node3:ssh       192.168.56.1:iua        ESTABLISHED on (0.22/0/0)
tcp        0      0 ansible-node3:ssh       192.168.56.120:48610    ESTABLISHED keepalive (6732.82/0/0)
tcp        0      0 ansible-node3:ssh       192.168.:multicast-ping ESTABLISHED keepalive (7207.95/0/0)
[root@ansible-node3 ~]#
```

可以看到，工作节点上面也正常显示了与Ansible控制节点的连接。



建立连接后，再次执行一下剧本，看看是否会降低用时：

```sh
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml

PLAY [basehosts] *****************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Show hostname] ******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "ansible-node1"
}
ok: [192.168.56.122] => {
    "msg": "ansible-node2"
}
ok: [192.168.56.123] => {
    "msg": "ansible-node3"
}

TASK [base : Set hostname] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.122]
ok: [192.168.56.121]

TASK [base : Set SELinux prints warnings instead of enforcing] *******************************************************************************************************************************************************************************************************************************
skipping: [192.168.56.121]
skipping: [192.168.56.122]
skipping: [192.168.56.123]

TASK [base : Ensure SELinux is set to disable mode] ******************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Get SELinux value] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Create a directory if it does not exist] ****************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Backup old repo config] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d.bak', u'src': u'/etc/yum.repos.d'})

TASK [base : Create backup directory] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Copy repo and pypi config] ******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/Centos-7.repo', u'src': u'Centos-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.121] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.123] => (item={u'dest': u'/etc/yum.repos.d/epel-7.repo', u'src': u'epel-7.repo'})
ok: [192.168.56.122] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.121] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})
ok: [192.168.56.123] => (item={u'dest': u'~/.pip/pip.conf', u'src': u'pip.conf'})

TASK [base : ensure a list of packages installed] ********************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [create base folder] ********************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.123]
changed: [192.168.56.122]

TASK [base : Extract safe-rm-0.12.tar.gz into /srv/safe-rm] **********************************************************************************************************************************************************************************************************************************
changed: [192.168.56.122]
changed: [192.168.56.123]
changed: [192.168.56.121]

TASK [base : Move safe-rm to /usr/bin] *******************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.121]
ok: [192.168.56.123]

TASK [base : Delete temp folder] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121]
changed: [192.168.56.122]
changed: [192.168.56.123]

TASK [base : Copy safe-rm config] ************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.121]
ok: [192.168.56.122]

TASK [base : Update pip command] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.123]
changed: [192.168.56.121]
changed: [192.168.56.122]

TASK [base : Install python package] *********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.122]
ok: [192.168.56.123]
ok: [192.168.56.121]

TASK [base : Sync time at every 10 minutes] **************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Sync time at 2:30 am] ***********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.123]
ok: [192.168.56.122]

TASK [base : Print the IP] *******************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121] => {
    "msg": "HOST_IP: 192.168.56.121"
}
ok: [192.168.56.122] => {
    "msg": "HOST_IP: 192.168.56.122"
}
ok: [192.168.56.123] => {
    "msg": "HOST_IP: 192.168.56.123"
}

TASK [base : Remove sshkey file] *************************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa)
changed: [192.168.56.122] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.121] => (item=/root/.ssh/id_rsa.pub)
changed: [192.168.56.123] => (item=/root/.ssh/id_rsa.pub)

TASK [base : Generate SSH key pair] **********************************************************************************************************************************************************************************************************************************************************
changed: [192.168.56.123]
changed: [192.168.56.122]
changed: [192.168.56.121]

TASK [base : Copy alias config] **************************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.121]
ok: [192.168.56.122]
ok: [192.168.56.123]

TASK [base : Insert block to .bashrc] ********************************************************************************************************************************************************************************************************************************************************
ok: [192.168.56.123]
ok: [192.168.56.122]
ok: [192.168.56.121]

PLAY RECAP ***********************************************************************************************************************************************************************************************************************************************************************************
192.168.56.121             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.122             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
192.168.56.123             : ok=26   changed=6    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0


real    0m20.642s
user    0m9.591s
sys     0m4.031s
[root@ansible ansible_playbooks]#
```

![Snipaste_2024-03-17_12-29-59.png](/img/Snipaste_2024-03-17_12-29-59.png)

奇怪了，用时还超了，变成了20.6秒！！



再执行一次，用时还是变多了：

```sh
[root@ansible ansible_playbooks]# time ansible-playbook -i base_hosts.ini base.yml
...过程输出省略
real    0m21.651s
user    0m9.436s
sys     0m4.177s
[root@ansible ansible_playbooks]#
```

通过以上实验可以看到：

- 开启长连接后，Ansible会保持和目标主机的持续连接，减少了连接的建立和断开时间，但是在执行剧本时，由于要维持这种长连接，可能会增加一些额外的网络开销和系统资源的消耗，导致执行剧本的时间变长。此外，可能还会受到网络延迟等因素的影响，进一步增加执行剧本的时间。因此，尽管长连接可以提高效率，但在某些情况下也可能导致执行时间变长。



### 2.2 开启pipelining

- pipelining也是OpenSSH的一个特性。
- 如果开启了pipelining功能，Ansible会改变默认的执行过程，默认情况下，Ansible有一个流程是把生成好的本地Python脚本PUT到远程服务器，开启pipelining功能后，这个过程将会在SSH的会话中进行，这样可以大大提高整个执行效率。
- 但开启pipelining,需要被控主机`/etc/sudoers`文件编辑当前Ansible SSH用户为`requiretty`，否则在执行时会报异常。